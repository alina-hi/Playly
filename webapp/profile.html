<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мой профиль - Playly</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
        }

        .navbar {
            background-color: #4CAF50;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 1.5rem;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: opacity 0.3s;
        }

        .nav-links a:hover {
            opacity: 0.8;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
        }

        .sidebar {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            height: fit-content;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background-color: #4CAF50;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            font-weight: bold;
            margin: 0 auto 1rem;
            overflow: hidden;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .display-name {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .username {
            color: #666;
            margin-bottom: 0.5rem;
        }

        .verified-badge {
            display: inline-block;
            background-color: #4CAF50;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .reputation {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 1rem;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .stat-item {
            text-align: center;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4CAF50;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        .profile-info {
            margin-top: 2rem;
        }

        .info-item {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }

        .info-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.3rem;
        }

        .info-value {
            font-size: 1rem;
            color: #333;
        }

        .main-content {
            display: grid;
            gap: 2rem;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #4CAF50;
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #333;
        }

        .edit-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }

        .edit-btn:hover {
            background-color: #45a049;
        }

        .about-text {
            line-height: 1.8;
            color: #555;
        }

        .interests-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .interest-tag {
            background-color: #e8f5e9;
            color: #2e7d32;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #4CAF50;
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background-color: #45a049;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .message {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            display: none;
        }

        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .age-range-select {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .age-option {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .age-option:hover {
            border-color: #4CAF50;
            background-color: #f8f9fa;
        }

        .age-option.selected {
            border-color: #4CAF50;
            background-color: #e8f5e9;
            color: #2e7d32;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                padding: 0 1rem;
            }

            .navbar {
                padding: 1rem;
            }

            .nav-container {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
<!-- Навигация -->
<nav class="navbar">
    <div class="nav-container">
        <a href="index.html" class="logo">Playly</a>
        <div class="nav-links">
            <a href="index.html">Главная</a>
            <a href="map">Карта площадок</a>
            <a href="profile.html" id="profileNav">Профиль</a>
            <a href="#" id="logoutLink">Выйти</a>
        </div>
    </div>
</nav>

<!-- Основной контент -->
<div class="container">
    <!-- Боковая панель с информацией -->
    <aside class="sidebar">
        <div class="profile-header">
            <div class="avatar" id="userAvatar">
                <!-- Аватар будет загружен через JS -->
            </div>
            <div class="display-name" id="userDisplayName"></div>
            <div class="username" id="userUsername"></div>
            <div class="verified-badge" id="verifiedBadge" style="display:none;">
                ✓ Верифицирован
            </div>
            <div class="reputation" id="userReputation"></div>
        </div>

        <div class="profile-stats">
            <div class="stat-item">
                <div class="stat-value" id="reviewsCount">0</div>
                <div class="stat-label">Отзывов</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="ratingsCount">0</div>
                <div class="stat-label">Оценок</div>
            </div>
        </div>

        <div class="profile-info">
            <div class="info-item">
                <div class="info-label">На сайте с</div>
                <div class="info-value" id="joinDate"></div>
            </div>
            <div class="info-item">
                <div class="info-label">Возраст детей</div>
                <div class="info-value" id="childAgeRange">Не указано</div>
            </div>
            <div class="info-item">
                <div class="info-label">Локация</div>
                <div class="info-value" id="userLocation">Не указано</div>
            </div>
        </div>
    </aside>

    <!-- Основная часть -->
    <main class="main-content">
        <!-- Карточка "О себе" -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">О себе</div>
                <button class="edit-btn" onclick="toggleEdit('about')">Редактировать</button>
            </div>
            <div id="aboutView">
                <div class="about-text" id="aboutText">Загрузка...</div>
            </div>
            <div id="aboutEdit" style="display:none;">
                <form id="aboutForm">
                    <div class="form-group">
                            <textarea class="form-control" id="aboutInput"
                                      placeholder="Расскажите о себе, своих интересах, как вы используете Playly..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-primary" onclick="saveAbout()">Сохранить</button>
                        <button type="button" class="btn btn-secondary" onclick="toggleEdit('about')">Отмена</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Карточка "Интересы" -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">Интересы</div>
                <button class="edit-btn" onclick="toggleEdit('interests')">Редактировать</button>
            </div>
            <div id="interestsView">
                <div class="interests-list" id="interestsList">
                    <!-- Интересы будут загружены через JS -->
                </div>
            </div>
            <div id="interestsEdit" style="display:none;">
                <form id="interestsForm">
                    <div class="form-group">
                        <label class="form-label">Ваши интересы (через запятую)</label>
                        <input type="text" class="form-control" id="interestsInput"
                               placeholder="Например: детские площадки, парки, мероприятия для детей">
                        <small style="color:#666; font-size:0.9rem;">Укажите что вам интересно в рамках Playly</small>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-primary" onclick="saveInterests()">Сохранить</button>
                        <button type="button" class="btn btn-secondary" onclick="toggleEdit('interests')">Отмена</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Карточка "Настройки профиля" -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">Настройки профиля</div>
            </div>
            <form id="profileForm">
                <div class="form-group">
                    <label class="form-label">Отображаемое имя *</label>
                    <input type="text" class="form-control" id="displayNameInput" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Возраст детей</label>
                    <div class="age-range-select" id="ageRangeSelect">
                        <div class="age-option" data-range="1-3">1-3 года</div>
                        <div class="age-option" data-range="3-6">3-6 лет</div>
                        <div class="age-option" data-range="6-10">6-10 лет</div>
                        <div class="age-option" data-range="10+">10+ лет</div>
                    </div>
                    <input type="hidden" id="childAgeRangeInput">
                </div>

                <div class="form-group">
                    <label class="form-label">Локация</label>
                    <input type="text" class="form-control" id="locationInput"
                           placeholder="Например: Санкт-Петербург, Приморский район">
                </div>

                <div class="form-group">
                    <label class="form-label">Ссылка на аватар (URL)</label>
                    <input type="text" class="form-control" id="avatarUrlInput"
                           placeholder="https://example.com/avatar.jpg">
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-primary" onclick="saveProfile()">Сохранить профиль</button>
                </div>
            </form>

            <div id="profileMessage" class="message"></div>
        </div>
    </main>
</div>

<script>
    let currentUser = null;

    document.addEventListener('DOMContentLoaded', function() {
        checkAuthAndLoadProfile();
        setupEventListeners();
    });

    async function checkAuthAndLoadProfile() {
        try {
            const response = await fetch('/playly/api/login', {
                method: 'GET'
            });

            const result = await response.json();

            if (result.success && result.authenticated) {
                loadProfile();
            } else {
                // Не авторизован - редирект на вход
                window.location.href = 'login.html';
            }
        } catch (error) {
            console.error('Auth check error:', error);
            showMessage('Ошибка проверки авторизации', 'error');
        }
    }

    async function loadProfile() {
        try {
            const response = await fetch('/playly/api/profile', {
                method: 'GET'
            });

            const result = await response.json();

            if (result.success) {
                currentUser = result.user;
                renderProfile();
            } else {
                showMessage('Ошибка загрузки профиля', 'error');
            }
        } catch (error) {
            console.error('Profile load error:', error);
            showMessage('Ошибка загрузки профиля', 'error');
        }
    }

    function renderProfile() {
        if (!currentUser) return;

        // Основная информация
        document.getElementById('userDisplayName').textContent = currentUser.displayName;
        document.getElementById('userUsername').textContent = '@' + currentUser.username;

        // Аватар
        const avatarDiv = document.getElementById('userAvatar');
        if (currentUser.avatarUrl) {
            avatarDiv.innerHTML = `<img src="${currentUser.avatarUrl}" alt="${currentUser.displayName}">`;
        } else {
            const initials = currentUser.displayName.charAt(0).toUpperCase();
            avatarDiv.textContent = initials;
            avatarDiv.style.backgroundColor = getColorFromName(currentUser.displayName);
        }

        // Верификация
        if (currentUser.isVerified) {
            document.getElementById('verifiedBadge').style.display = 'inline-block';
        }

        // Репутация
        document.getElementById('userReputation').textContent =
            `Репутация: ${currentUser.reputation.toFixed(1)}/10.0`;

        // Даты
        if (currentUser.createdAt) {
            const joinDate = new Date(currentUser.createdAt).toLocaleDateString('ru-RU');
            document.getElementById('joinDate').textContent = joinDate;
        }

        // О себе
        document.getElementById('aboutText').textContent =
            currentUser.about || 'Пользователь пока ничего не рассказал о себе.';
        document.getElementById('aboutInput').value = currentUser.about || '';

        // Возраст детей
        if (currentUser.childAgeRange) {
            document.getElementById('childAgeRange').textContent = currentUser.childAgeRange;
            // Выбираем соответствующую опцию
            document.querySelectorAll('.age-option').forEach(option => {
                if (option.dataset.range === currentUser.childAgeRange) {
                    option.classList.add('selected');
                    document.getElementById('childAgeRangeInput').value = currentUser.childAgeRange;
                }
            });
        }

        // Локация
        if (currentUser.location) {
            document.getElementById('userLocation').textContent = currentUser.location;
            document.getElementById('locationInput').value = currentUser.location;
        }

        // Интересы
        renderInterests();
        document.getElementById('interestsInput').value = currentUser.interests || '';

        // Отображаемое имя в форме
        document.getElementById('displayNameInput').value = currentUser.displayName;

        // Аватар URL
        document.getElementById('avatarUrlInput').value = currentUser.avatarUrl || '';
    }

    function renderInterests() {
        const interestsList = document.getElementById('interestsList');
        interestsList.innerHTML = '';

        if (!currentUser.interests || currentUser.interests.trim() === '') {
            interestsList.innerHTML = '<div style="color:#666;">Интересы не указаны</div>';
            return;
        }

        const interests = currentUser.interests.split(',').map(i => i.trim()).filter(i => i !== '');

        if (interests.length === 0) {
            interestsList.innerHTML = '<div style="color:#666;">Интересы не указаны</div>';
            return;
        }

        interests.forEach(interest => {
            const tag = document.createElement('div');
            tag.className = 'interest-tag';
            tag.textContent = interest;
            interestsList.appendChild(tag);
        });
    }

    function setupEventListeners() {
        // Выбор возраста детей
        document.querySelectorAll('.age-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.age-option').forEach(o => o.classList.remove('selected'));
                this.classList.add('selected');
                document.getElementById('childAgeRangeInput').value = this.dataset.range;
            });
        });

        // Выход
        document.getElementById('logoutLink').addEventListener('click', async function(e) {
            e.preventDefault();
            try {
                const response = await fetch('/playly/api/logout', {
                    method: 'POST'
                });

                const result = await response.json();
                if (result.success) {
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('Logout error:', error);
            }
        });
    }

    function toggleEdit(section) {
        const view = document.getElementById(section + 'View');
        const edit = document.getElementById(section + 'Edit');

        if (view.style.display === 'none') {
            view.style.display = 'block';
            edit.style.display = 'none';
        } else {
            view.style.display = 'none';
            edit.style.display = 'block';
        }
    }

    async function saveAbout() {
        const about = document.getElementById('aboutInput').value.trim();

        try {
            const response = await fetch('/playly/api/profile', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ about: about })
            });

            const result = await response.json();

            if (result.success) {
                currentUser.about = about;
                document.getElementById('aboutText').textContent = about || 'Пользователь пока ничего не рассказал о себе.';
                toggleEdit('about');
                showMessage('Информация обновлена', 'success');
            } else {
                showMessage(result.message || 'Ошибка сохранения', 'error');
            }
        } catch (error) {
            console.error('Save about error:', error);
            showMessage('Ошибка сохранения', 'error');
        }
    }

    async function saveInterests() {
        const interests = document.getElementById('interestsInput').value.trim();

        try {
            const response = await fetch('/playly/api/profile', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ interests: interests })
            });

            const result = await response.json();

            if (result.success) {
                currentUser.interests = interests;
                renderInterests();
                toggleEdit('interests');
                showMessage('Интересы обновлены', 'success');
            } else {
                showMessage(result.message || 'Ошибка сохранения', 'error');
            }
        } catch (error) {
            console.error('Save interests error:', error);
            showMessage('Ошибка сохранения', 'error');
        }
    }

    async function saveProfile() {
        const displayName = document.getElementById('displayNameInput').value.trim();
        const childAgeRange = document.getElementById('childAgeRangeInput').value;
        const location = document.getElementById('locationInput').value.trim();
        const avatarUrl = document.getElementById('avatarUrlInput').value.trim();

        if (!displayName) {
            showMessage('Отображаемое имя обязательно', 'error');
            return;
        }

        const profileData = {
            displayName: displayName,
            childAgeRange: childAgeRange,
            location: location,
            avatarUrl: avatarUrl
        };

        try {
            const response = await fetch('/playly/api/profile', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(profileData)
            });

            const result = await response.json();

            if (result.success) {
                currentUser = result.user;
                renderProfile();
                showMessage('Профиль успешно обновлен', 'success');
            } else {
                showMessage(result.message || 'Ошибка сохранения', 'error');
            }
        } catch (error) {
            console.error('Save profile error:', error);
            showMessage('Ошибка сохранения', 'error');
        }
    }

    function showMessage(text, type) {
        const messageDiv = document.getElementById('profileMessage');
        messageDiv.textContent = text;
        messageDiv.className = `message ${type}`;
        messageDiv.style.display = 'block';

        setTimeout(() => {
            messageDiv.style.display = 'none';
        }, 3000);
    }

    function getColorFromName(name) {
        // Генерируем цвет на основе имени
        const colors = [
            '#4CAF50', '#2196F3', '#9C27B0', '#FF9800',
            '#E91E63', '#00BCD4', '#8BC34A', '#FF5722'
        ];
        const hash = name.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
        return colors[hash % colors.length];
    }
</script>
</body>
</html>